<!-- This is the configuration for CLARIAH NDE harvesting. -->
<config>

  <!-- ### configuration settings ### -->
  <settings>
    <!-- Working directory. -->
    <workdir>workspace</workdir>

    <!-- Maximum number of attempts per record before giving up. -->
    <max-retry-count>2</max-retry-count>

    <!-- Delay between retries of a record (seconds). -->
    <retry-delay>10</retry-delay>
    
    <!-- Delay between requests (seconds). -->
    <nice-delay>10</nice-delay>
    
    <!-- Maximum number of concurrent harvester threads -->
    <max-jobs>1</max-jobs>

    <!-- Number of resources placed in the resource pool. -->
    <resource-pool-size>4</resource-pool-size>

    <!-- Default timeout (for connection and reading) for a single
    http request in seconds. If unspecified, will be INFINITE.  -->
    <timeout>120</timeout>
    
    <!-- File used to store endpoint -> directory mappings -->
    <map-file>map.csv</map-file>

    <protocol>nl.mpi.oai.harvester.protocol.NdeProtocol</protocol>
    <scenario>ListRecords</scenario>

    <nde-ListRecords-sparql text-expand="yes" endpoint="https://triplestore.netwerkdigitaalerfgoed.nl/repositories/registry">
        PREFIX dcat: &lt;http://www.w3.org/ns/dcat#>
        PREFIX dct:  &lt;http://purl.org/dc/terms/>
        PREFIX schema: &lt;http://schema.org/>
        
        SELECT ?publisher ?dataset ?distribution ?p ?o WHERE {{
          BIND(&lt;{$provider-url}> as ?publisher)
      
          {{
            ?dataset dct:publisher ?publisher;
              ?p ?o .
            FILTER(?p != schema:dateRead)    
          }}
          UNION
          {{
            ?dataset dct:publisher ?publisher;
              dcat:distribution ?distribution.
            ?distribution ?p ?o . 
          }}
        
        }} ORDER BY ?dataset
    </nde-ListRecords-sparql>

    <incremental>false</incremental>
    <dry-run>false</dry-run>
  </settings>

  <!-- ### output directories (referenced in the action section) ### -->
  <directories>
    <!-- When the attribute 'max-files' is non-zero, subdirectories
         will be created to ensure no directory has more than that
         number of files. -->
    <dir path="cmdi" id="rec" max-files="0"/>
    <dir path="middle" id="request" max-files="0"/>
    <dir path="start" id="result" max-files="0"/>
  </directories>

  <!-- ### actions to take on metadata formats (in order of preference) ### -->
  <actions>
    <format match="type" value="*">
      <action type="save" dir="result" suffix=".xml"/>
      <action type="nl.mpi.oai.harvester.action.NDESplitAction"/>
      <action type="save" dir="request" suffix=".xml"/>
      <!--<action type="transform" file="https://raw.githubusercontent.com/CLARIAH/harvest-config/develop/srx2cmdi.xsl"/>
      <action type="save" dir="rec" suffix=".xml"/>-->
    </format>
  </actions>

  <!-- ### list of providers ### -->
  <providers>
    <provider url="https://rkd.nl/" name="RKD Nederlands Instituut voor Kunstgeschiedenis" exclusive="true"/>
    <provider url="https://www.beeldengeluid.nl" name="Nederlands Instituut voor Beeld en Geluid"/>
  </providers>
</config>
